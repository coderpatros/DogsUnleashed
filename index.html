<!--
    Copyright 2016 Patrick Dwyer

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>
-->
<html>
<head>
    <meta charset=utf-8 />
    <title>Dogs Unleashed</title>
    <!-- Set the viewport for mobile devices -->
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Reference leaflet and esri leaflet for working with arcgis services-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet-src.js"></script>
    <script src="https://unpkg.com/esri-leaflet@2.0.4"></script>

    <!-- Include a font I like :) -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

    <!-- Include github button js -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin:0;
            padding:0;
        }

        /* Makes the map take up the whole screen */
        #map { position: absolute; top:0; bottom:0; right:0; left:0; }

        /* This is for the GitHub fork me button */
        #fork-me {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 20px;
            text-align: center;
            z-index: 500;
        }

        /* This is for the disclaimer popup */
        #disclaimer {
            visibility: hidden;
            position: absolute;
            left: 0;
            top: 0;
            width:100%;
            height:100%;
            text-align:center;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.75);
        }

        #disclaimer div {
            width: 300px;
            margin: 50px auto;
            background-color: #fff;
            border: 1px solid #000;
            padding: 15px;
            text-align:center;
        }

        ul.legend {
            text-align: left;
            list-style-type: square;
        }

        ul.legend .legend-text {
            color: #000;
        }
    </style>
</head>
<body>

<!-- Div for the map, take note of the id, it's used below -->
<div id="map"></div>

<!-- Div for GitHub fork me button -->
<div id="fork-me">
    <a class="github-button" href="https://github.com/patros/DogsUnleashed/fork" data-style="mega" aria-label="Fork me on GitHub">Fork me on GitHub</a>
</div>

<!-- Disclaimer popup content -->
<div id="disclaimer">
    <div>
        <strong>Dogs Unleashed</strong>
        <p>This is a map with all the SCC dog off leash areas and dog water bowls. This was an idea that came out of SCC HackFest 2015.</p>
        <ul class="legend">
            <li style="color: #009933"><span class="legend-text">Dogs off leash all the time</span></li>
            <li style="color: #ffff00"><span class="legend-text">Dogs off leash sometimes (click on area for details)</span></li>
            <li style="color: #ff6600"><span class="legend-text">Dogs on leash all the time</span></li>
            <li style="color: #ff0000"><span class="legend-text">Dogs prohibited all the time</span></li>
        </ul>
        <p><img src="https://gisservices.scc.qld.gov.au/arcgis/rest/services/Structure/Structure_SCRC/MapServer/1/images/b859de9190ff66de02e473ecfeaa0d34">Dog water bowls</p>
        <p><img src="https://gisservices.scc.qld.gov.au/arcgis/rest/services/Society/Society_SCRC/MapServer/5/images/8251fc70af1559cd0ad513d6d839eff5">Beach access near a dog area</p>
        <p>Designated areas may change. Ensure you check current signage at the location.</p>
        <p><button type="button" onclick='disclaimerToggle()'>Continue</button></p>
    </div>
</div>

<script>
    // Used to display/hide the disclaimer popup
    function disclaimerToggle() {
        el = document.getElementById("disclaimer");
        el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
    }

    // Styles to be applied to each off leash area polygon based on the value of the feature's Times_1 property
    var offLeashStyles = {
        "Dogs prohibited at all times": {
            color: "#ff0000"
        },
        "Dogs off leash at all times": {
            color: "#009933"
        },
        "Dogs off leash at times indicated on signs": {
            color: "#ffff00"
        },
        "Dogs off leash 4pm to 8am": {
            color: "#ffff00"
        },
        "Dogs off leash 5am to 8am and 5pm to 8pm": {
            color: "#ffff00"
        },
        "Dogs off leash May to October, 4pm to 8am": {
            color: "#ffff00"
        },
        "Pedestrian Thoroughfare - dogs on leash at all times": {
            color: "#ff6600"
        },
        "Spectators with dogs on leash at all times allowed": {
            color: "#ff6600"
        }
    };

    // Initialise leaflet map in the element with the id 'map', set initial position (-26.653127, 153.067969) and zoom (11)
    var map = L.map('map').setView([ -26.653127, 153.067969 ], 11);
    // Set map base layer to the esri "Streets" layer (refer to
    // https://esri.github.io/esri-leaflet/api-reference/layers/basemap-layer.html for more options)
    L.esri.basemapLayer('Streets').addTo(map);

    // Initialise a feature layer for the off leash area polygons
    var offLeashAreas = L.esri.featureLayer({
        url: 'https://gisservices.scc.qld.gov.au/arcgis/rest/services/Boundaries/Boundaries_SCRC/MapServer/6',
        // function used to style the polygons
        style: function (feature) {
            // default styles
            var style = {
                color: "#000000",
                fillOpacity: 0.5,
                weight: 2
            };

            // apply styles based on the Times_1 feature property
            var additionalStyles = offLeashStyles[feature.properties.Times_1] || {};
            for (var styleName in additionalStyles) {
                if (additionalStyles.hasOwnProperty(styleName)) {
                    style[styleName] = additionalStyles[styleName];
                }
            }

            // we use the style color as the fillColor (polygon background colour)
            style.fillColor = style.color;
            return style;
        }
    });
    offLeashAreas.addTo(map);
    // this bit sets up the off leash area polygon popups
    offLeashAreas.bindPopup(function (evt) {
        return L.Util.template('<p>{Times_1}<br>{Location}</p>', evt.feature.properties);
    });

    // Initialise a feature layer for dog bowl points of interest
    var waterFittings = L.esri.featureLayer({
        url: 'https://gisservices.scc.qld.gov.au/arcgis/rest/services/Structure/Structure_SCRC/MapServer/1',
        // this overrides the default map marker icon to use an image
        pointToLayer: function (geojson, latlng) {
            return L.marker(latlng, {
                icon: L.icon({
                    iconUrl: "https://gisservices.scc.qld.gov.au/arcgis/rest/services/Structure/Structure_SCRC/MapServer/1/images/b859de9190ff66de02e473ecfeaa0d34",
                    // override this to match your image size
                    iconSize: [18, 18],
                    // keep this half/half of above if you want it centered, otherwise adjust it for icons like pins to
                    // make sure the pin point is in the right spot
                    iconAnchor: [9, 9],
                    // adjust this to modify the popup point location
                    popupAnchor: [0, -11]
                })
            });
        }
    });
    // filter this feature layer based on the feature property AssetSubType
    waterFittings.setWhere("AssetSubType='Dog Bowl'");
    waterFittings.addTo(map);
    // this bit sets up the dog bowl point of interest popups
    waterFittings.bindPopup(function (evt) {
        return L.Util.template('<p>{AssetSubType}<br>{LocationDesc}</p>', evt.feature.properties);
    });

    // Initialise a feature layer for beach access points near dog areas
    // this does a bit of trickery to filter the beach access points to only display if they are within 250m of a dog area boundary
    function filterBeachAccessPoints() {
        beachAccess.eachFeature(function(beachAccessLayer) {
            var include = false;
            offLeashAreas.eachFeature(function(offLeashAreaLayer) {
                for (var i=0; i<offLeashAreaLayer._latlngs.length; i++) {
                    for (var j=0; j<offLeashAreaLayer._latlngs[i].length; j++) {
                        var points = offLeashAreaLayer._latlngs[i][j];
                        if (points.lat && points.lng) {
                            points = [points];
                        }
                        for (var k=0; k<points.length; k++) {
                            if (beachAccessLayer.getLatLng().distanceTo(points[k]) < 250) {
                                include = true;
                                break;
                            }
                        }
                        if (include) break;
                    }
                    if (include) break;
                }
            });
            try {
                if (include) {
                    L.DomUtil.setOpacity(beachAccessLayer._icon, 1);
                } else {
                    L.DomUtil.setOpacity(beachAccessLayer._icon, 0);
                }
            } catch (e) {
                // we'll ignore this, the beach access point doesn't have a dom element
            }
        });
    }

    var beachAccess = L.esri.featureLayer({
        url: 'https://gisservices.scc.qld.gov.au/arcgis/rest/services/Society/Society_SCRC/MapServer/5',
        // this overrides the default map marker icon to use an image
        pointToLayer: function (geojson, latlng) {
            return L.marker(latlng, {
                icon: L.icon({
                    iconUrl: "https://gisservices.scc.qld.gov.au/arcgis/rest/services/Society/Society_SCRC/MapServer/5/images/8251fc70af1559cd0ad513d6d839eff5",
                    // override this to match your image size
                    iconSize: [18, 18],
                    // keep this half/half of above if you want it centered, otherwise adjust it for icons like pins to
                    // make sure the pin point is in the right spot
                    iconAnchor: [9, 9],
                    // adjust this to modify the popup point location
                    popupAnchor: [0, -11]
                })
            });
        }
    });
    // filter this feature layer based on the feature property AssetSubType
    beachAccess.setWhere("AccessType='Pedestrian Access'");
    beachAccess.addTo(map);
    // this bit sets up the beach access point of interest popups
    beachAccess.bindPopup(function (evt) {
        return L.Util.template('<p>{LocationDescription}<br>{Street}, {Suburb}</p>', evt.feature.properties);
    });
    // sets up the filtering
    offLeashAreas.on("load", filterBeachAccessPoints);
    beachAccess.on("load", filterBeachAccessPoints);


    // initial display of the disclaimer
    disclaimerToggle();
</script>

</body>
</html>